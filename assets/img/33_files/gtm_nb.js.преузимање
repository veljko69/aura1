/*$(function() {

    //add to cart
/!*    $(document).ready(function() {


    });*!/
gtmDataObject.push({
 [[DATA]]
});
});*/

function googleTagManager_metricData(metricData, typePage){

    if(typeof gtmDataObject === 'undefined' || gtmDataObject === null){
        return
    }

    gtmDataObject.push({
        'isEnvironmentProd': ''+metricData.isEnvironmentProd+'',
        'pageName': ''+metricData.name+'',
        'pageType':  ''+typePage+'',
        'pageCategory': '',
        'pageSubCategory': '',
        'pageTechnology': 'Multiple',
        'market': ''+metricData.market+'',
        'version': ''+metricData.version+'',
        'landscape': 'B2C_AgentCustomLandscape',
        'segmentBusiness': ''+metricData.segmentBusiness+'',
        'currency': '​'+metricData.currency+'',
        'clubMemberID': ''+metricData.clubMemberID+'',
        'clubMemberStatus': ''+metricData.clubMemberStatus+'',
        'clubMemberLevel': ''+metricData.clubMemberLevel+'',
        'clubMemberLevelID': ''+metricData.clubMemberLevelID+'',
        'clubMemberTitle': ''+metricData.clubMemberTitle+'',
        'clubMemberLoginStatus': ''+metricData.clubMemberLoginStatus+'',
        'machineOwner': ''+metricData.machineOwner+'',
        'machineOwned': ''+metricData.machineOwned+'',
        'preferredTechnology': ''+metricData.preferredTechnology+''
    });

    switch(typePage) {

        case 'page':
            break;

        case 'product':
            gtg_viewProductPage(metricData);

            break;

        case 'product_list':
            //gtm_viewPage();
            break;

        case 'cart':
            //gtm_viewPage();
            gtm_CartSteps(metricData);
            break;

        case 'cart_confirm':
            //print in confirm page
            break;

        case 'confirm_registration':

            break;

        case 'article_details':

            break;


        default:

            break;

    }

    gtm_viewPage();
    gtm_mainSliderClick(metricData);
    gtm_addToCart(metricData);
    gtm_newRegistration();
    NewsletterSendSuccess();
    gtm_ProductClick(metricData);
    removeFromCartGTM(metricData);
    //UserMachineInfo(metricData);
    impressionsOnScroll = ProductImpresionsOnScroll(metricData);
    gtm_impressionsOnClick(metricData);
    LoginEventGTM();
    UserMachineInfo(metricData);

}

var impressionsOnScroll;


function gtm_viewPage(){

    gtmDataObject.push({
        'event': 'event_pageView'
    });

}

function gtg_viewProductPage(metricProduct){
    var dimension56Name = 'OriginalLine';
    gtmDataObject.push({
        'event': 'detailView',
        'currencyCode': ''+metricProduct.currency+'',
        'ecommerce': {
            'detail': {
                'actionField': {},
                'products': [{
                    'name': ''+metricProduct.name+'',
                    'id': ''+metricProduct.id+'',
                    'dimension54': ''+metricProduct.name+'',
                    'dimension53': ''+metricProduct.productCode+'',
                    'quantity': ''+metricProduct.price+'',
                    'price': ''+metricProduct.price+'',
                    'category': ''+metricProduct.categoryName+'',
                    'dimension56':''+dimension56Name+'',
                    'brand': 'Nespresso',
                    'dimension57': 'single'
                }
                ]}
        }
    });


    //append event for click to add to cart and add to wishlist
    //*gtm_addToCart(metricProduct);
    //gtg_AddToWishlist(metricProduct);
}


function gtm_addToCart(metricProduct){

    var dimension56Name = 'OriginalLine';

    var button = $('.product-sizes-v3 .product-sizes.quantity-active .quantity-select-wrapper').children();
    var buttonInput = $('.product-sizes-v3 .add-to-cart-button');
    var quantity;
    var gtagAddToCart = false;
    var p_data={};
    var categoryid,m10='',m11='',m12='';
    var productDetailButton =$('.product-detail-buy');

    //detail
    var productDetailButtonQuantity =$('.products-detail-wrapper .quantity-button-wrapper').children();
    var productDetailButtonInputQuantity = $('.products-detail-wrapper .input-quantity-wraper .add-to-cart-button');

    button.add(buttonInput).add(productDetailButtonQuantity).add(productDetailButtonInputQuantity).click(function(){

        if($(this).data('quantity')){
            quantity = $(this).data('quantity');
        }
        else{
            quantity = $(this).parent().find('input').val();
        }

        p_data = $(this).parents('.product-item').data();

        if(typeof p_data == 'undefined'){
            p_data = {};
            p_data.productname = metricProduct.name;
            p_data.productid = metricProduct.id;
            p_data.productcode = metricProduct.productCode;
            p_data.productprice = metricProduct.price;
            p_data.productcategory = metricProduct.type;
            p_data.quantity = quantity;
            p_data.productcategoryid = metricProduct.typeId;
        }

    });

//todo metric10/11/12 - kada se ubaci vrsta proizvoda

    window.addEventListener('cartButtonClick', function (e){
            //console.log( p_data);
        if(!p_data) return;

        m10='';m11='';m12='';
        switch (parseInt(p_data.productcategoryid)) {
            case 2:
                m10 = quantity;//kapsule
                break;
            case 3:
                m11 = quantity;//masine
                break;
            case 4:
                m12 = quantity;//accessories
                break;
        }
        gtagAddToCart = true;

        if(gtagAddToCart && p_data){
            gtmDataObject.push({
                'event': 'addToCart',
                'currencyCode': ''+metricProduct.currency+'',
                'ecommerce': {
                    'add': {
                        'actionField': {},
                        'products': [{
                            'name': ''+p_data.productname+'',
                            'id': ''+p_data.productid+'',
                            'dimension54': ''+p_data.productname+'',
                            'dimension53': ''+p_data.productcode+'',
                            'quantity': quantity,
                            'price': ''+p_data.productprice+'',
                            'category': ''+p_data.productcategory+'',
                            'dimension56':''+dimension56Name+'',
                            'brand': '​Nespresso',
                            'metric10':m10,
                            'metric11':m11,
                            'metric12':m12,
                            'dimension57': 'single'
                        }
                        ]}
                }
            });
            gtagAddToCart = false;
        }
        //console.log(gtmDataObject);
    });

}

function gtm_mainSliderClick(metricData){

    var $slider = $('.slider-init');
    var $static_slider = $('.slider-static .item');
    var sldeACtiveSldeTitile;
    var s_position,s_name,s_id,s_creative;

    if(!$slider.length) return;

//click on sliders
    $slider.add($static_slider).click(function(e){

        s_position = $(this).data('gtm-slider-position'); //block slider
        s_position = s_position  || '';
        s_id = $(this).find('.slick-current').data('gtm-slider-id');
        s_id = s_id  || $(this).data('gtm-slider-id');
        s_name = $(this).find('.slick-current').data('gtm-slider-name');
        s_name = s_name  || '';
        s_creative = $(this).find('.slick-current').data('gtm-slider-creative');
        s_creative = s_creative  || '';

        //e.preventDefault();//skloniti nakon testiranja

        isinmenu = $(this).parents('.slider-menu').length;
        isinfooter = $(this).parents('.gtm-no-footer').length;
        isinfooterBottom = $(this).parents('.footer-wrapper').length;

        if((isinfooter==0) && (isinfooterBottom==0) && s_name !='' ){
            if(!$(e.target).is('.slick-dots button')) {
                //console.log('click '+s_id);
                gtmDataObject.push({
                    'event': 'promoClick',
                    'currencyCode': '',
                    'ecommerce': {
                        'promoClick': {
                            'promotions': [
                                {
                                    'name': ''+s_name+'',
                                    'id': ''+s_id+'',
                                    'creative': ''+s_creative+'',
                                    'position': ''+s_position+''
                                }
                            ]
                        }
                    }
                });
            }
        }

    });

    //OnChange - ne skroz
    var isinmenu,isinfooter,$sliderO ={};

    function SliderChange(obj){
        gtmDataObject.push({
            'event': 'promoSliderChange',
            'currency': ''+obj.currency+'',
            'ecommerce': {
                'promoView': {
                    'promotions': [
                        {
                            'name': ''+obj.name+'',
                            'id': ''+obj.id+'',
                            'creative': ''+obj.creative+'',
                            'position': ''+obj.position+''
                        }
                    ]
                }
            }
        });
    }

    var change_count = 0;
    var slides_count;
    $slider.on('afterChange', function(event, slick, currentSlide, nextSlide){

        slides_count = $(this).data('gtm-slider-items');
        s_position = $(this).data('gtm-slider-position'); //block slider
        s_position = s_position  || '';
        s_id = $(this).find('.slick-current').data('gtm-slider-id');
        s_id = s_id  || '';
        s_name = $(this).find('.slick-current').data('gtm-slider-name');
        s_name = s_name  || '';
        s_creative = $(this).find('.slick-current').data('gtm-slider-creative');
        s_creative = s_creative  || '';

        //object
        $sliderO.pos = s_position;
        $sliderO.id = s_id;
        $sliderO.name = s_name;
        $sliderO.creative = s_creative;
        $sliderO.currency = metricData.currency;

        isinmenu = $(this).parents('.slider-menu').length;
        isinfooter = $(this).parents('.gtm-no-footer').length;
        isinfooterBottom = $(this).parents('.footer-wrapper').length;

        if((isinmenu == 0) && (isinfooter==0) && (isinfooterBottom==0)){
            if(change_count < slides_count){
                SliderChange($sliderO);
                change_count++;
            }
        }


    });

}

//klik za registraciju

function gtm_newRegistration(){

    var regpage = false;
    var steps;
    var text;
    var counterSteps=0;
    var finalStep = false;
    var machineOwnerObj;
    var machineOwner='',machine='',label='',labelid;
    var textNoNumber;
    machineOwnerObj = {owner:'', machineOwned:'',elabel:''};

    function RegisterSteoPush(step){
        gtmDataObject.push({
            'event': 'newAccountRegistration',
            'newAccountStep': ''+step+''
        });
    }

    function registerFinalStep(param){
        gtmDataObject.push({
            'event': 'customEvent',
            'eventCategory': 'User Engagement',
            'eventAction': 'New User Account Creation',
            'eventLabel': ''+param.elabel+'',
            'machineOwner': ''+param.owner+'',
            'machineOwned': ''+param.machineOwned+'',
            'preferredTechnology': '',
            'landscape': 'B2C_AgentCustomLandscape',
            'segmentBusiness': 'B2C',
            'newAccountStep': 'Welcome to Nespresso'
        });
        gtmDataObject.push({
            'event': 'customEvent',
            'newAccountStep': 'Machine Info',
            'eventCategory': 'User Engagement',
            'eventAction': 'Club Member Account Action',
            'eventLabel': 'Already Own Machine',
            'machineOwner': ''+param.owner+''
        });
    }


    //da li je strana registracija
    if($('.registration-page').length > 0){
        regpage = true;
    }


    if(regpage){
        steps = $('.register-steps-btn-wrapper .step');
        $(document).on('RegisterStepClick', function() {
            if(counterSteps < 3){
                text = $(steps[counterSteps]).text();
                textNoNumber = text.replace(/[0-9]/g, '').trim();
                RegisterSteoPush(textNoNumber);
            }
            counterSteps++;
        });

        //da li ima masinu
        $('input[name=reg_page_have_product]').click(function(){
            var machineOwner = $(this).val();
            machineOwner = (machineOwner == 2) ? 'No' :'Yes';
            machineOwnerObj.machineOwned = '';
            var labelid = $(this).attr('id');
            label = $("label[for='"+labelid+"']").text();
            machineOwnerObj.owner = machineOwner;
            machineOwnerObj.elabel = label;
        });

        $('.reg-products-product-group-select .item').click(function(){
            machineOwnerObj.machineOwned = $(this).find('.title').text().trim();
        });

        $('#reg_page_submit').click(function(e){
                //e.preventDefault();
                var cstep = steps.length-2;
                text = $(steps[cstep]).text();
                textNoNumber = text.replace(/[0-9]/g, '').trim();

                if(!finalStep){
                    RegisterSteoPush(textNoNumber);
                    registerFinalStep(machineOwnerObj);
                    finalStep = true;
                }

            });

    }//kraj stranice

}

function gtm_CartSteps(metricData){

    $buttons = $('.cart-steps-btn-wrapper .step');
    var firsttime = false;
    var stepname,cartproductsarray = [];


    function ActionPush(metricData, stepName){
        var dimension56Name = 'OriginalLine';
        cartproductsarray=[];
        $('#order_cart_content .cart-table tr.item').each(function(){
            var productObj = {
                'name': '',
                'id': '',
                'dimension54': '',
                'dimension53': '',
                'quantity': 1,
                'price': '',
                'category': '',
                'dimension56': ''+dimension56Name+'',
                'brand': 'Nespresso',
                'dimension57':'single'
            };

            product = $(this).data();
            productObj.name = product.productname;
            productObj.id = product.productid;
            productObj.dimension54 = product.productname;
            productObj.dimension53 = product.productcode;
            productObj.price = product.productprice;
            productObj.category = product.productcategory;


            product.quantity = $(this).find('.cart-quantity select').val();
            productObj.quantity = product.quantity;

            cartproductsarray.push(productObj);
        });
        //console.log(stepName);
        gtmDataObject.push({
            'event': 'checkout',
            'currencyCode': ''+metricData.currency+'',
            'ecommerce': {
                'checkout': {
                    'actionField': {
                        'step': 1,
                        'checkoutStepName': ''+stepName+'',
                    },
                    'products': cartproductsarray
                }
            }
        });
    }
    if(!firsttime){
        setTimeout(function () {
            stepname = $('.cart-steps-btn-wrapper .step.active').clone().children().remove().end().text();
            firsttime = true;
            if(stepname !== ''){
                ActionPush(metricData, stepname);
            }
        }, 510);
    }
    $buttons.click(function(){
        stepname = $('.cart-steps-btn-wrapper .step.active:not(.checked)').clone().children().remove().end().text();
        ActionPush(metricData, stepname);
    });

}

function NewsletterSendSuccess(){

    $(document).on('popSubscribeSuccess', function() {

        gtmDataObject.push({
            'event': 'customEvent',
            'eventCategory': 'User Engagement',
            'eventAction': 'Newsletter Sign Up Pop-Up',
            'eventLabel': 'Newsletter Sign Up Pop-Up - Confirmed'
        });
    });
}

function gtm_ProductClick(metricData){
    var dimension56Name = 'OriginalLine';
var $item = $('.product-item');
var isinslider,$parent,productObj={};
var list,list_cat;
    $item.click(function(e){
        //e.preventDefault();

        if ($(this).is(".active")) {
            return false
        }
        //product Object
        productObj= $(this).data();

        $parent = $(this).parents('.slider.product');

        isinslider = $parent.length;
        isinslider = (isinslider > 0) ? true :false;

        if(isinslider){
            list = $parent.data('list-name');
        }else{
            list_cat =  ' - '+$(this).closest("[data-list-name]").data('list-name')
            list = metricData.name+list_cat;
        }
        //console.log(list);

        gtmDataObject.push({
            'event': 'productClick',
            'currencyCode': ''+metricData.currency+'',
            'ecommerce': {
                'click': {
                    'actionField': {
                        'list' : ''+list+'',
                    },
                    'products': [
                        {
                            'name': ''+productObj.productname+'',
                            'id': ''+productObj.productid+'',
                            'dimension54': ''+productObj.productname+'',
                            'dimension53': ''+productObj.productid+'',
                            'price': ''+productObj.productprice+'',
                            'category': ''+productObj.productcategory+'',
                            'dimension56': ''+dimension56Name+'',
                            'brand': 'Nespresso',
                            'dimension57': 'single',
                            'position': productObj.productposition
                        }
                    ]
                }
            }
        });
    });

}
function ProductImpresionsOnScroll(metricData){
    var dimension56Name = 'OriginalLine';
    var productItem = $('.product .product-item'),
        listName,list,list_cat;
    var productObjEach ={};
    var impressionsOnScroll = [];
    var productObjArray = {};
    var productObj = {
        'name': '',
        'id': '',
        'dimension54': '',
        'dimension53': '',
        'price': '',
        'category': '',
        'dimension56': ''+dimension56Name+'',
        'brand': '',
        'dimension57': '',
        'list': '',
        'position': 1,
    };

    productObjArray['currencyCode'] = ''+metricData.currency+'';
    if(!productItem.length) return;

    productItem.each(function(){
        productObjEach = {};
        productObjEach = $(this).data();
        listName = $(this).parents('.block').data('list-name');
        if(!listName){
            list_cat =  $(this).closest("[data-list-name]").data('list-name');
            if(list_cat){
                list_cat = ' - '+list_cat;
            }else {
                list_cat = '';
            }
            list = metricData.name+list_cat;
            listName = list;
        }


        if(!productObjEach.productname) return;
        productObj = {};
        productObj.name = ''+productObjEach.productname+'';
        productObj.id = ''+productObjEach.productid+'';
        productObj.dimension54 = ''+productObjEach.productname+'';
        productObj.dimension53 = ''+productObjEach.productcode+'';
        productObj.price = ''+productObjEach.productprice+'';
        productObj.category = ''+productObjEach.productcategory+'';
        productObj.dimension56 = ''+dimension56Name+'';
        productObj.brand = 'Nespresso';
        productObj.dimension57 = 'single';
        productObj.list = ''+listName+'';
        productObj.position = productObjEach.productposition;

        //add object to another object
        productObjArray[productObjEach.productcode] = productObj;

    });
    //console.log(productObjArray);
    //add objet to array
    impressionsOnScroll.push(productObjArray);

    //console.log(productObjArray);
    return productObjArray;

}
function removeFromCartGTM(metricData){

    var dimension56Name = 'OriginalLine';

        var product={},quantity,m13='',m14='',m15='',product1 ={};
        //var del = $('.product-item-remove');

    window.addEventListener('initCartOnePage', function (e) {
        var del = $('.product-item-remove');
        del.click(function(e){
            product={};
            product = $(this).parents('.item').data();
            quantity = $(this).parents('.item').find('.cart-quantity select').val();
            if(!product.quantity){
                product.quantity = quantity;
            }
            product1 = product;
            //console.log(product);
        });
        //console.log('korpa inicijalizovana');
    });
/*        del.click(function(e){
            product={};
            product = $(this).parents('.item').data();
            quantity = $(this).parents('.item').find('.cart-quantity select').val();
            if(!product.quantity){
                product.quantity = quantity;
            }
            product1 = product;
            console.log(product);
        });*/
    window.addEventListener('deleteProductFromCartOnePage', function (e) {

        m13='';m14='';m15='';
        switch (product.productcategoryid) {
            case 2:
                m13 = product.quantity;//kapsule
                break;
            case 3:
                m14 = product.quantity;//masine
                break;
            case 4:
                m15 = product.quantity;//accessories
                break;
        }
        gtmDataObject.push({
            'event': 'removeFromCart',
            'currencyCode': ''+metricData.currency+'',
            'ecommerce': {
                'remove': {
                    'actionField': {
                    },
                    'products': [
                        {
                            'name':''+product.productname+'',
                            'id': ''+product.productid+'',
                            'dimension54': ''+product.productname+'',
                            'dimension53': ''+product.productcode+'',
                            'quantity': product.quantity,
                            'price': ''+product.productprice+'',
                            'category': ''+product.productcategory+'',
                            'dimension56':''+dimension56Name+'',
                            'brand': 'Nespresso',
                            'metric13': m13,
                            'metric14': m14,
                            'metric15': m15,
                            'dimension57':'single'
                        }
                    ]
                }
            }
        });
    });

}



function gtm_impressionsOnClick(metricData){
    var dimension56Name = 'OriginalLine';
var fancyclick = $('.open-item-popup > .item');
var popup, list = metricData.name,items=[];
    var item = {
        'name': '',
        'id': '',
        'dimension54': '',
        'dimension53': '',
        'price': '',
        'category': '',
        'dimension56': ''+dimension56Name+'',
        'brand': 'Nespresso',
        'dimension57':'single',
        'list':'',
        'position':1
    };

    fancyclick.click(function(){

        popup = $('body').find('#item-popup-description .items-wrapper.product > .item');
        list += ' popup';
        popup.each(function(){

            productObjEach = {};
            productObjEach = $(this).data();
            item = {};
            item.name = ''+productObjEach.productname+'';
            item.id = ''+productObjEach.productid+'';
            item.dimension54 = ''+productObjEach.productname+'';
            item.dimension53 = ''+productObjEach.productcode+'';
            item.price = ''+productObjEach.productprice+'';
            item.category = ''+productObjEach.productcategory+'';
            item.dimension56 = ''+dimension56Name+'';
            item.brand = 'Nespresso';
            item.dimension57 = 'single';
            item.list = ''+list+'';
            item.position = productObjEach.productposition;

            items.push(item);
        });
        //console.log(items);
        gtmDataObject.push({
            'event': 'customProductImpressionAction',
            'currencyCode': ''+metricData.currency+'',
            'ecommerce': {
                'impressions': items
            }
        });
    });



}

function LoginEventGTM(){
    window.addEventListener('loginUser', function (e) {
       var obj = e.detail;
        gtmDataObject.push({
            'event': 'userLogin',
            'eventCategory': 'User Engagement',
            'eventAction': 'User Login',
            'loginMethod': 'Standard',
            'clubMemberID': ''+obj.clubMemberID+'',
            'clubMemberStatus': ''+obj.clubMemberStatus+'',
            'clubMemberLevel': ''+obj.clubMemberLevel+'',
            'clubMemberLevelID': ''+obj.clubMemberLevelID+'',
            'clubMemberTitle': ''+obj.clubMemberTitle+'',
            'clubMemberLoginStatus': ''+obj.clubMemberLoginStatus+'',
            'machineOwned': ''+obj.machineOwned+'',
            'preferredTechnology': ''+obj.preferredTechnology+'',
            'machineOwner': ''+obj.machineOwner+''
        });
    });


}

function UserMachineInfo(metricData){
    var machine_wrapper = $('#add-form-my-product');
    var machineOwned;
    var isprofile = metricData.uniqueCode === 'profile';
    var button = $('#my_product_add_product');
    //console.log(isprofile);
    if(isprofile){
        machineOwned='';
        $('#add-form-my-product .item:not(.profile-products-product-group-select)').click(function(){
           machineOwned = $(this).find('.title').text().trim();
        });
        button.click(function(e){

            gtmDataObject.push({
                'event': 'customEvent',
                'eventCategory': 'User Engagement',
                'eventAction': 'New User Machine',
                'eventLabel': 'Own Machine',
                'machineOwner': 'Yes',
                'machineOwned': ''+machineOwned+'',
                'preferredTechnology': ''+metricData.preferredTechnology+''
            });
        });

    }

}

function transactionGtm360(order,oItems,orderAdress, orderBillingAdress){
    console.log(oItems);
 /*       gtmDataObject.push({
            'event': 'transaction',
            'currencyCode': 'AED',
            'transactionTotal': '446.21',
            'userCreditAmountUsed': '20.00',
            'newClient': 'true',
            'ecommerce': {
                'purchase': {
                    'actionField': {
                        'id': ''+order.id+'',
                        'affiliation': ''+order.storeName+'',
                        'revenue': ''+order.totalProductsNoTax+'',
                        'tax': ''+order.tax+'',
                        'shipping': ''+order.totalCarrier+'',
                        'coupon':''+order.voucher+'',
                        'clubActionTotalAmount': '',
                        'shippingAddressCity': ''+orderAdress.city+'',
                        'shippingAddressState': ''+orderAdress.countryGeo+'',
                        'shippingAddressCountry': ''+orderAdress.countryGeo+'',
                        'shippingAddressPostalCode': ''+orderAdress.postcode+'',
                        'billingAddressCity': ''+orderBillingAdress.city+'',
                        'billingAddressState': ''+orderBillingAdress.countryGeo+'',
                        'billingAddressCountry': ''+orderBillingAdress.countryGeo+'',
                        'billingAddressPostalCode': ''+orderBillingAdress.postcode+'',
                        'clubActionID': '',
                        'checkoutMainPaymentMethod': ''+order.typePayment+'',
                        'checkoutShippingMethodID': '0Y',
                        'deliveryOption_Priority': 'FALSE',
                        'deliveryOption_Signature': 'TRUE',
                        'deliveryOption_Recycling': 'TRUE',
                    },
                    'products': [
                        {
                            'name': 'Roma',
                            'id': '7889.20',
                            'dimension54': 'Roma',
                            'dimension53': '7439.20',
                            'quantity': 100,
                            'price': '1.00',
                            'category': 'Capsule',
                            'dimension56':'VirtuoLine',
                            'brand': 'Nespresso',
                            'metric6': 100,
                            'metric5': '0',
                            'metric9': '0',
                            'dimension59': 'True',
                            'dimension57': 'single'
                        }

                    ]
                }
            }
        });*/



}





